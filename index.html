<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Schema Association Task</title>

    <!-- jsPsych core + plugins -->
    <script src="https://unpkg.com/jspsych@8.2.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>

    <link
      href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css"
      rel="stylesheet"
      type="text/css"
    />

    <style>
      body {
        background-color: #fafafa;
        font-family: sans-serif;
        text-align: center;
      }
      img {
        max-height: 500px;
        margin: 30px;
      }
      .jspsych-btn {
        font-size: 18px;
        margin: 10px;
      }
    </style>
  </head>

  <body></body>

  <script>
    // Initialize jsPsych
    const jsPsych = initJsPsych({
      on_finish: () => jsPsych.data.displayData()
    });

    const image_folder = "schema_diag/";   // Folder containing your .png images
    const json_path = "stimuli.js";        // The JSON file with conceptA, conceptB columns
    const jitter_range = [400, 600];       // Random jitter duration range (ms)
    const image_duration = 2500;           // Image display duration (ms)

    // --------------------------
    // Helper functions
    // --------------------------
    function randomJitter() {
      return Math.floor(Math.random() * (jitter_range[1] - jitter_range[0])) + jitter_range[0];
    }

    // Function to create a trial from a pair
    function makeTrial(conceptA, conceptB) {
      const timeline = [];

      // Jitter before A
      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size:80px;">+</div>',
        trial_duration: randomJitter(),
        choices: "NO_KEYS"
      });

      // Show concept A
      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<img src='${image_folder + conceptA}.png'>`,
        trial_duration: image_duration,
        choices: "NO_KEYS",
        data: { conceptA, conceptB, phase: "A" }
      });

      // Jitter
      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size:80px;">+</div>',
        trial_duration: randomJitter(),
        choices: "NO_KEYS"
      });

      // Show concept B
      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<img src='${image_folder + conceptB}.png'>`,
        trial_duration: image_duration,
        choices: "NO_KEYS",
        data: { conceptA, conceptB, phase: "B" }
      });

      // Jitter
      // timeline.push({
      //   type: jsPsychHtmlKeyboardResponse,
      //   stimulus: "",
      //   trial_duration: randomJitter(),
      //   choices: "NO_KEYS"
      // });

      // Association Yes/No
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `<p>Do you think these two concepts are connected?</p>`,
        choices: ["Yes", "No"],
        data: { conceptA, conceptB, task: "association" }
      });

      // Relation type
      timeline.push({
        timeline: [{
        type: jsPsychHtmlButtonResponse,
        stimulus: `<p>What type of relation do they have?</p>`,
        choices: [
          "Inferential relation",
          "Part-whole relation",
          "Categorical relation",
          "Thematic relation"
        ],
        data: { conceptA, conceptB, task: "relation_type" }
        }],
        conditional_function: () => jsPsych.data.get().last(1).values()[0].response === 0
      });
      
      return { timeline };
    }

    // --------------------------
    // Start screen
    // --------------------------
    const start_screen = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <h2>Schema Association Task</h2>
        <p>You will see two geometric concepts, one after another.<br>
        Decide whether they are connected and specify the relation type.</p>
      `,
      choices: ["Start Experiment"]
    };

    // --------------------------
    // Load JSON and Build Experiment
    // --------------------------
    fetch(json_path)
      .then(response => {
        if (!response.ok) throw new Error(`Failed to load JSON: ${response.status}`);
        return response.json();
      })
      .then(data => {
        // console.log("Loaded data:", data);

        // Extract pairs from the JSON
        const concept_pairs = data.map(row => [row.conceptA, row.conceptB]);
        const image_files = concept_pairs.flat().map(c => image_folder + c + ".png");

        // Preload images
        const preload = {
          type: jsPsychPreload,
          images: image_files
        };

        // Build all trials
        const trials = concept_pairs.map(([A, B]) => makeTrial(A, B));

        // Complete timeline
        const timeline = [start_screen, preload, ...trials];

        // Run the experiment
        jsPsych.run(timeline).then(() => {
          const csvData = jsPsych.data.get().csv();

          // Send data to Google Sheets via Apps Script endpoint
          fetch("https://script.google.com/macros/s/AKfycbwwyTb3hUaLYi7Jvfl2qLJOrkgR5U_5azQ5aGBtEZsc1CslbR2D7lXdTQJhM6tp0iEeKw/exec", {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ data: csvData })
          });
        });
      })
      .catch(err => {
        console.error("Error loading JSON:", err);
        document.body.innerHTML = `<p style='color:red;'>Error loading data file. Check console for details.</p>`;
      });
  </script>
</html>